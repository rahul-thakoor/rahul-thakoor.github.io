<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Making mdBooks work offline - rahul thakoor</title>
  <meta property="og:title" content="Making mdBooks work offline" />
  <meta name="twitter:title" content="Making mdBooks work offline" />
  <meta name="description" content="Use workbox to cache your mdBook contents">
  <meta property="og:description" content="Use workbox to cache your mdBook contents">
  <meta name="twitter:description" content="Use workbox to cache your mdBook contents">
  <meta name="author" content="Rahul Thakoor"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "rahul thakoor",
    
    "url": "https:\/\/rahul-thakoor.github.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/rahul-thakoor.github.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/rahul-thakoor.github.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/rahul-thakoor.github.io\/making-mdbooks-work-offline\/",
          "name": "Making md books work offline"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Rahul Thakoor"
  },
  "headline": "Making mdBooks work offline",
  "description" : "Use workbox to cache your mdBook contents",
  "inLanguage" : "en",
  "wordCount":  840 ,
  "datePublished" : "2019-03-04T18:06:48",
  "dateModified" : "2019-03-04T18:06:48",
  "image" : "https:\/\/rahul-thakoor.github.io",
  "keywords" : [ "rust, mdbook, web" ],
  "mainEntityOfPage" : "https:\/\/rahul-thakoor.github.io\/making-mdbooks-work-offline\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/rahul-thakoor.github.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/rahul-thakoor.github.io",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Making mdBooks work offline" />
<meta property="og:description" content="Use workbox to cache your mdBook contents">
<meta property="og:image" content="https://rahul-thakoor.github.io/img/mdbook_offline_new_version_prompt.png" />
<meta property="og:url" content="https://rahul-thakoor.github.io/making-mdbooks-work-offline/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="rahul thakoor" />
  <meta name="twitter:title" content="Making mdBooks work offline" />
  <meta name="twitter:description" content="Use workbox to cache your mdBook contents">
  <meta name="twitter:image" content="https://rahul-thakoor.github.io/img/mdbook_offline_new_version_prompt.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@rahulthakoor" />
  <meta name="twitter:creator" content="@rahulthakoor" />
  <link href='https://rahul-thakoor.github.io/img/favicon_r.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://rahul-thakoor.github.io/img/mdbook_offline_new_version_prompt.png" />
  <meta name="twitter:image" content="https://rahul-thakoor.github.io/img/mdbook_offline_new_version_prompt.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@rahulthakoor" />
  <meta name="twitter:creator" content="@rahulthakoor" />
  <meta property="og:url" content="https://rahul-thakoor.github.io/making-mdbooks-work-offline/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="rahul thakoor" />

  <meta name="generator" content="Hugo 0.84.4" />
  <link rel="alternate" href="https://rahul-thakoor.github.io/index.xml" type="application/rss+xml" title="rahul thakoor">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://rahul-thakoor.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://rahul-thakoor.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://rahul-thakoor.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-118403602-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://rahul-thakoor.github.io">rahul thakoor</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="/">Home</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">Projects</a>
              <div class="navlinks-children">
                
                  <a href="/page/nodebotsmu">Nodebots Mauritius</a>
                
                  <a href="/physical-computing-rust/">Physical Computing With Rust</a>
                
                  <a href="/page/rust_gpiozero">rust_gpiozero</a>
                
              </div>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Making mdBooks work offline</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
  
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Rahul Thakoor
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p><code>mdBook</code><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> is a great utility to create online books from Markdown files. It is used extensively in the Rust community. Here are some books made with <code>mdBook</code>:</p>
<ul>
<li>The Rust Programming Language (<em>&ldquo;the book&rdquo;</em>)<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></li>
<li>Embedded Book <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></li>
<li>mdBook user guide<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></li>
</ul>
<h2 id="motivation">Motivation</h2>
<ul>
<li>I usually read the books while commuting and this usually consumes mobile data. Given the contents don&rsquo;t change that often, I thought it would be useful if they were cached.</li>
<li>Prevent the dreaded <em>&ldquo;no internet connection&rdquo;</em> screen (downasaur).</li>
<li>I want to eventually convert an <code>mdBook</code> into a PWA<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>. Offline support is important for reliability.</li>
</ul>
<h2 id="google-workbox">Google Workbox</h2>
<p>A service worker<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup> is responsible for caching and retrieving resources from the cache (among other things). Google&rsquo;s Workbox<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup> <em>is a library that bakes in a set of best practices and removes the boilerplate every developer writes when working with service workers.</em> It allows us to precache assets, and also cache assets at runtime. There are several caching strategies<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup> which can be selected depending on your specific use-case.</p>
<h2 id="customising-the-mdbook">Customising the mdBook</h2>
<p>I followed Google&rsquo;s workbox codelab<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup> and modified the steps accordingly. mdBook allows us to add additional javascript via the <code>additional-js</code> option in <code>book.toml</code>. We need to add a service worker registration code in the template page:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// source: https://codelabs.developers.google.com/codelabs/workbox-lab/#2
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#39;serviceWorker&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">navigator</span>) {
    window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;load&#39;</span>, () =&gt; {
      <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">serviceWorker</span>.<span style="color:#a6e22e">register</span>(<span style="color:#e6db74">&#39;sw.js&#39;</span>)
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">registration</span> =&gt; {
          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Service Worker registered! Scope: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">scope</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
        })
        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; {
          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Service Worker registration failed: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">err</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
        });
    })
  }
</code></pre></div><p>The code attempts to install a service worker(<code>sw.js</code>)</p>
<p>We can save the above code in a file, <code>register-sw.js</code> and save it at the root level of the book. Then in <code>book.toml</code> add the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[<span style="color:#a6e22e">output</span>.<span style="color:#a6e22e">html</span>]
<span style="color:#a6e22e">additional-js</span>=[<span style="color:#e6db74">&#34;register-sw.js&#34;</span>]
</code></pre></div><p>Next I created a basic service worker file(<code>sw.js</code>) at the root level of the book.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// source: https://codelabs.developers.google.com/codelabs/workbox-lab/#3
</span><span style="color:#75715e"></span><span style="color:#a6e22e">importScripts</span>(<span style="color:#e6db74">&#39;https://storage.googleapis.com/workbox-cdn/releases/3.5.0/workbox-sw.js&#39;</span>);

<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">workbox</span>) {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Yay! Workbox is loaded ðŸŽ‰`</span>);

  <span style="color:#a6e22e">workbox</span>.<span style="color:#a6e22e">precaching</span>.<span style="color:#a6e22e">precacheAndRoute</span>([]);

} <span style="color:#66d9ef">else</span> {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Boo! Workbox didn&#39;t load ðŸ˜¬`</span>);
}
</code></pre></div><p>However, when I used the code above, routes with search parameters were not being served properly. I removed search parameters using <code>ignoreUrlParametersMatching</code><sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup>. Also, besides precaching, we need to cache some assets like google fonts which mdBook uses and then update the cache when new versions are available. I changed the <code>sw.js</code> to the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">importScripts</span>(
  <span style="color:#e6db74">&#34;https://storage.googleapis.com/workbox-cdn/releases/3.5.0/workbox-sw.js&#34;</span>
);

<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">workbox</span>) {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Yay! Workbox is loaded ðŸŽ‰`</span>);

  <span style="color:#a6e22e">workbox</span>.<span style="color:#a6e22e">precaching</span>.<span style="color:#a6e22e">precacheAndRoute</span>([], {
    <span style="color:#a6e22e">ignoreUrlParametersMatching</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">/.*/</span>]
  });

  <span style="color:#75715e">// Cache the Google Fonts stylesheets with a stale while revalidate strategy.
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">workbox</span>.<span style="color:#a6e22e">routing</span>.<span style="color:#a6e22e">registerRoute</span>(
    <span style="color:#e6db74">/^https:\/\/fonts\.googleapis\.com/</span>,
    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">workbox</span>.<span style="color:#a6e22e">strategies</span>.<span style="color:#a6e22e">CacheFirst</span>({
      <span style="color:#a6e22e">cacheName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;google-fonts-stylesheets&#34;</span>
    })
  );

  <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;activate&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">event</span>) {
    
    <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">waitUntil</span>(
      <span style="color:#a6e22e">caches</span>.<span style="color:#a6e22e">keys</span>().<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">cacheNames</span>) {
        <span style="color:#66d9ef">return</span> Promise.<span style="color:#a6e22e">all</span>(
          <span style="color:#a6e22e">cacheNames</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">cacheName</span>) {

          }).<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">cacheName</span>) {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">caches</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">cacheName</span>);
          })
        );
      })
    );
  });

  <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">event</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">action</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;skipWaiting&#39;</span>) {
      <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">skipWaiting</span>();
    }
  });

} <span style="color:#66d9ef">else</span> {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Boo! Workbox didn&#39;t load ðŸ˜¬`</span>);
}

</code></pre></div><p>I modified the <code>registration-sw.js</code> to prompt the user when updates are available based on suggestions on this post<sup id="fnref:11"><a href="#fn:11" class="footnote-ref" role="doc-noteref">11</a></sup>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">indexController</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;

<span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;serviceWorker&#34;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">navigator</span>) {
  window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;load&#34;</span>, () =&gt; {
    <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">serviceWorker</span>
      .<span style="color:#a6e22e">register</span>(<span style="color:#e6db74">&#34;sw.js&#34;</span>)
      .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">registration</span> =&gt; {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">waiting</span>) {
          <span style="color:#a6e22e">indexController</span>.<span style="color:#a6e22e">updateReady</span>(<span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">waiting</span>);
          <span style="color:#66d9ef">return</span>;
        }
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">installing</span>) {
          <span style="color:#a6e22e">indexController</span>.<span style="color:#a6e22e">trackInstalling</span>(<span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">installing</span>);
          <span style="color:#66d9ef">return</span>;
        }

        <span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;updatefound&#34;</span>, <span style="color:#66d9ef">function</span>() {
          <span style="color:#a6e22e">indexController</span>.<span style="color:#a6e22e">trackInstalling</span>(<span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">installing</span>);
        });

        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Service Worker registered! Scope: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">registration</span>.<span style="color:#a6e22e">scope</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
      })
      .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Service Worker registration failed: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">err</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
      });
  });
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">trackInstalling</span>(<span style="color:#a6e22e">worker</span>) {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">indexController</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
  <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;statechange&#34;</span>, <span style="color:#66d9ef">function</span>() {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;installed&#34;</span>) {
      <span style="color:#a6e22e">indexController</span>.<span style="color:#a6e22e">updateReady</span>(<span style="color:#a6e22e">worker</span>);
    }
  });
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">updateReady</span>(<span style="color:#a6e22e">worker</span>) {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">confirm</span>(<span style="color:#e6db74">&#34;New version available, reload page?&#34;</span>);
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>) {
    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">postMessage</span>({ <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;skipWaiting&#34;</span> });
    <span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">reload</span>();
  }
}

</code></pre></div><p>Here we are showing a confirm box to prompt the user that there is a new version of the book available. It is based on Jake Archibald&rsquo;s suggestion<sup id="fnref:12"><a href="#fn:12" class="footnote-ref" role="doc-noteref">12</a></sup>. Ideally, you would show a banner when a service worker has updated and waiting to install.</p>
<p>Now, everytime we build the book, we need to generate the proper &ldquo;revision hashes&rdquo; to the files in the manifest entries. We can use the <code>workbox-cli</code><sup id="fnref:13"><a href="#fn:13" class="footnote-ref" role="doc-noteref">13</a></sup> to inject a precache manifest into the service worker. You need <code>node.js</code> to use the cli. During the setup, we can choose which file types we want to cache. The configuration is saved in <code>workbox-config.js</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
  <span style="color:#e6db74">&#34;globDirectory&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;book/&#34;</span>,
  <span style="color:#e6db74">&#34;globPatterns&#34;</span><span style="color:#f92672">:</span> [
    <span style="color:#e6db74">&#34;**/*.{css,js,html,png,eot,svg,ttf,woff,woff2,json}&#34;</span>
  ],
  <span style="color:#e6db74">&#34;swDest&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;book/sw.js&#34;</span>,
  <span style="color:#e6db74">&#34;swSrc&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sw.js&#34;</span>
};
</code></pre></div><p>You can modify the <code>globPatterns</code> accordingly. The production service worker will be <code>book/sw.js</code>. After building the book, we need to run the <code>workbox injectManifest workbox-config.js</code> command.</p>
<p><img src="/img/mdbook_offline_new_version_prompt.png" alt="new versioon available"></p>
<h2 id="automating-the-build-in-travis-ci">Automating the build in Travis CI</h2>
<p>You can customise the build to generate the proper service worker every time there is a change. I made a sample repo<sup id="fnref:14"><a href="#fn:14" class="footnote-ref" role="doc-noteref">14</a></sup>.
You should set an environment variable <code>GITHUB_TOKEN</code> in <code>Travis CI</code>. Youâ€™ll need to generate a personal access token with the <code>public_repo</code> or <code>repo</code> scope on <code>Github</code>. This can be done in <code>Settings</code> &gt; <code>Developer settings</code> &gt; <code>Personal access tokens</code> &gt; <code>Generate new token</code></p>
<p><img src="/img/mdbook_offline_travis.png" alt="travis build success"></p>
<h2 id="thats-it">That&rsquo;s it!</h2>
<p>Hope you find this useful and integrate service workers in your mdBook so your users can enjoy your content wherever they are! If you want to help, you can contribute to make the sample repo<sup id="fnref:14"><a href="#fn:14" class="footnote-ref" role="doc-noteref">14</a></sup> better.</p>
<h2 id="references">References</h2>
<!-- [^pcwr]: https://rahul-thakoor.github.io/physical-computing-rust/ -->
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://github.com/rust-lang-nursery/mdBook">mdBook</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://doc.rust-lang.org/book/">The Rust Programming Language</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://rust-embedded.github.io/book/">Embedded Book</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p><a href="https://rust-lang-nursery.github.io/mdBook/">mdBook user Documentation</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps">Progressive Web Apps</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Workers</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7" role="doc-endnote">
<p><a href="https://developers.google.com/web/tools/workbox/">Workbox</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8" role="doc-endnote">
<p><a href="https://developers.google.com/web/tools/workbox/modules/workbox-strategies">Workbox strategies</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9" role="doc-endnote">
<p><a href="https://codelabs.developers.google.com/codelabs/workbox-lab">Workbox Codelab</a>&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:10" role="doc-endnote">
<p><a href="https://developers.google.com/web/tools/workbox/modules/workbox-precaching#ignore_url_parameters">Ignore URL Parameters</a>&#160;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:11" role="doc-endnote">
<p><a href="https://stackoverflow.com/questions/40100922/activate-updated-service-worker-on-refresh">Activate updated service worker on refresh</a>&#160;<a href="#fnref:11" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:12" role="doc-endnote">
<p><a href="https://github.com/jakearchibald/wittr/compare/task-update-notify...update-interaction">Toast to show sw updated</a>&#160;<a href="#fnref:12" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:13" role="doc-endnote">
<p><a href="https://developers.google.com/web/tools/workbox/guides/precache-files/cli">Workbox CLI</a>&#160;<a href="#fnref:13" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:14" role="doc-endnote">
<p><a href="https://github.com/rahul-thakoor/mdBook-offline-support">Sample repository</a>&#160;<a href="#fnref:14" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


        
          <div class="blog-tags">
            
              <a href="https://rahul-thakoor.github.io/tags/rust/">rust</a>&nbsp;
            
              <a href="https://rahul-thakoor.github.io/tags/mdbook/">mdbook</a>&nbsp;
            
              <a href="https://rahul-thakoor.github.io/tags/web/">web</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f&amp;text=Making%20mdBooks%20work%20offline&amp;via=rahulthakoor" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//plus.google.com/share?url=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f" target="_blank" title="Share on Google Plus">
          <i class="fab fa-google-plus"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f&amp;title=Making%20mdBooks%20work%20offline" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f&amp;title=Making%20mdBooks%20work%20offline" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f&amp;title=Making%20mdBooks%20work%20offline" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2frahul-thakoor.github.io%2fmaking-mdbooks-work-offline%2f&amp;description=Making%20mdBooks%20work%20offline" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  
              </div>
            </section>
        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://rahul-thakoor.github.io/releasing-rust_gpiozero-v0.2.0/" data-toggle="tooltip" data-placement="top" title="Releasing rust_gpiozero v0.2.0">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://rahul-thakoor.github.io/using-no-standard-library-crates-with-webassembly/" data-toggle="tooltip" data-placement="top" title="Using no standard library crates with Webassembly">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:rahul.thakoor@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rahul-thakoor" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/rahulthakoor" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/rahul-thakoor-a50706138" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://paypal.me/rahulthakoor" title="PayPal">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-paypal fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Rahul Thakoor
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://rahul-thakoor.github.io">rahul thakoor</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.84.4</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://rahul-thakoor.github.io/js/main.js"></script>
<script src="https://rahul-thakoor.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://rahul-thakoor.github.io/js/load-photoswipe.js"></script>








  </body>
</html>

